#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/poll.h>

#include "74hc595.h"
#include "matrix.h"
#include "graphics.h"
#include "tools.h"

#include <matrix-config.h>

const static unsigned char waiting[] = {
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xde, 0xff, 0xff, 0xff, 0xff,
        0xf7, 0xff, 0xff, 0xff, 0xaa, 0xd2, 0x9c, 0x7f, 0xff, 0xab, 0x56, 0xaa,
        0xff, 0xff, 0xaa, 0x56, 0xad, 0xff, 0xff, 0xd6, 0x5a, 0xaa, 0xff, 0xff,
        0xff, 0xff, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff, 0xff,
        0xff, 0xff, 0xb6, 0xbf, 0xff, 0xff, 0xff, 0x0a, 0x7f, 0xff, 0xff, 0xff,
        0xaa, 0xff, 0xff, 0xff, 0xff, 0xb6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff, 0xee, 0xcc, 0xee,
        0xcb, 0x67, 0xdd, 0x55, 0x45, 0xda, 0xab, 0xdd, 0x55, 0x5d, 0xda, 0xab,
        0xee, 0xd5, 0x6e, 0xeb, 0x6b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0c, 0x30, 0xc3, 0x0c,
        0x30, 0x6d, 0xb6, 0xdb, 0x6d, 0xb6, 0x6d, 0xb6, 0xdb, 0x6d, 0xb6, 0x6d,
        0xb6, 0xdb, 0x6d, 0xb6, 0x6d, 0xb6, 0xdb, 0x6d, 0xb6, 0x61, 0x86, 0x18,
        0x61, 0x86, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0c, 0x30, 0xc3, 0x0c, 0x30,
        0x6d, 0xb6, 0xdb, 0x6d, 0xb6, 0x6d, 0xb6, 0xdb, 0x6d, 0xb6, 0x6d, 0xb6,
        0xdb, 0x6d, 0xb6, 0x6d, 0xb6, 0xdb, 0x6d, 0xb6, 0x61, 0x86, 0x18, 0x61,
        0x86, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

void wait_for_connection(void) {
    struct pollfd fds;
    fds.fd = 0; /* this is STDIN */
    fds.events = POLLIN;
    
    picture_t *pic = picture_alloc();
    picture_raw2pic(pic, waiting);
    matrix_update(pic);
    
    for(;;) {
        int i;
        static int state = 0;
        static int ani = 0;
        
        int ret = poll(&fds, 1, 0);
        if(ret == 1)
            break;
        
        picture_scroll_part(pic, SCROLL_LEFT, 28, 6);
        switch(state) {
            case 0:
                picture_setPixel(pic, 39, 33, 1);
                break;
            case 1:
                picture_setPixel(pic, 39, 33, 1);
                break;
            case 2:
            case 5:
                for(i = 0 ; i < 6 ; i++)
                        picture_setPixel(pic, 39, 33-i, 1);
                break;
            case 3:
                picture_setPixel(pic, 39, 28, 1);
                break;
            case 4:
                picture_setPixel(pic, 39, 28, 1);
                break;
            default:
                break;
        }
        
        if(++ani == 4) {
            static int state = 0;
            ani=0;
            picture_scroll_part(pic, SCROLL_RIGHT, 35, 6);
            switch(state) {
                case 0:
                    picture_setPixel(pic, 0, 40, 1);
                    break;
                case 1:
                    picture_setPixel(pic, 0, 40, 1);
                    break;
                case 2:
                case 5:
                    for(i = 0 ; i < 6 ; i++)
                            picture_setPixel(pic, 0, 40-i, 1);
                    break;
                case 3:
                    picture_setPixel(pic, 0, 35, 1);
                    break;
                case 4:
                    picture_setPixel(pic, 0, 35, 1);
                    break;
                default:
                    break;
            }
            if(++state == 6)
                state = 0;
        }
        
        if(++state == 6)
            state = 0;
        
        usleep(50000);
        matrix_update(pic);
    }    
out:
    picture_free(pic);
}

int main(void) {
    printf("Hello, this Kitchen-Matrix %s.%s (sources: %s-%s)\n",
        MATRIX_VERSION_MAJOR,
	MATRIX_VERSION_MINOR,
	MATRIX_GIT_BRANCH,
	MATRIX_GIT_COMMIT_HASH);

    printf("Initializing Hardware....\n");
    matrix_init();

    printf("Phasers on standby...\n");
    
    wait_for_connection();
    printf("Fire!\n");
    picture_t *pic = picture_alloc();

    while( read(0, *pic, sizeof(picture_t)) == sizeof(picture_t) ) {
        matrix_update(pic);
    }

    picture_free(pic);
    
    printf("Shutting down...\n");
    matrix_close();

    return 0;
}
